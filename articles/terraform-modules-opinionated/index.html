<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=theme-color content="dark"><title>Terraform modules: be opinionated | Aiman Ismail</title>
<meta property="og:site_name" content="Aiman Ismail"><meta property="og:title" content="Terraform modules: be opinionated | Aiman Ismail"><meta itemprop=name content="Terraform modules: be opinionated | Aiman Ismail"><meta name=twitter:title content="Terraform modules: be opinionated | Aiman Ismail"><meta name=application-name content="Terraform modules: be opinionated | Aiman Ismail"><meta name=twitter:card content="summary"><meta name=description content="I'm learning stuff."><meta name=twitter:description content="I'm learning stuff."><meta itemprop=description content="I'm learning stuff."><meta property="og:description" content="I'm learning stuff."><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=stylesheet href=/sass/main.min.ab99ff095f832511e24ffb2fba2b51ad473b2f7e9301d674eba2c6c3a6e8bd81.css><script src=https://beamanalytics.b-cdn.net/beam.min.js data-token=e393181a-2c64-49b0-8360-7566dfad6e5c async></script></head><script>(function(){const e="ThemeColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="ThemeColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.userColorScheme="dark":document.documentElement.dataset.userColorScheme="light"})()</script><body class=dark><nav class=navbar><div class=container><div class=flex><div><a class=brand href=/>Aiman Ismail</a></div><div class=flex><a href=/articles/>Articles</a>
<button id=dark-mode-button><svg class="light" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform:rotate(360deg);-webkit-transform:rotate(360deg);transform:rotate(360deg)" viewBox="0 0 36 36"><path fill="#ffd983" d="M30.312.776C32 19 20 32 .776 30.312c8.199 7.717 21.091 7.588 29.107-.429C37.9 21.867 38.03 8.975 30.312.776z"/><path d="M30.705 15.915a1.163 1.163.0 101.643 1.641 1.163 1.163.0 00-1.643-1.641zm-16.022 14.38a1.74 1.74.0 000 2.465 1.742 1.742.0 100-2.465zm13.968-2.147a2.904 2.904.0 01-4.108.0 2.902 2.902.0 010-4.107 2.902 2.902.0 014.108.0 2.902 2.902.0 010 4.107z" fill="#ffcc4d"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)"/></svg><svg class="dark" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform:rotate(360deg);-webkit-transform:rotate(360deg);transform:rotate(360deg)" viewBox="0 0 36 36"><path fill="#ffd983" d="M16 2s0-2 2-2 2 2 2 2v2s0 2-2 2-2-2-2-2V2zm18 14s2 0 2 2-2 2-2 2h-2s-2 0-2-2 2-2 2-2h2zM4 16s2 0 2 2-2 2-2 2H2s-2 0-2-2 2-2 2-2h2zm5.121-8.707s1.414 1.414.0 2.828-2.828.0-2.828.0L4.878 8.708s-1.414-1.414.0-2.829c1.415-1.414 2.829.0 2.829.0l1.414 1.414zm21 21s1.414 1.414.0 2.828-2.828.0-2.828.0l-1.414-1.414s-1.414-1.414.0-2.828 2.828.0 2.828.0l1.414 1.414zm-.413-18.172s-1.414 1.414-2.828.0.0-2.828.0-2.828l1.414-1.414s1.414-1.414 2.828.0.0 2.828.0 2.828l-1.414 1.414zm-21 21s-1.414 1.414-2.828.0.0-2.828.0-2.828l1.414-1.414s1.414-1.414 2.828.0.0 2.828.0 2.828l-1.414 1.414zM16 32s0-2 2-2 2 2 2 2v2s0 2-2 2-2-2-2-2v-2z"/><circle fill="#ffd983" cx="18" cy="18" r="10"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)"/></svg></button></div></div></div></nav><main><div class=container><article><header class=article-header><div class=thumb><div><h1>Terraform modules: be opinionated</h1><div class=post-meta><div>By Aiman Ismail | <time>December 08, 2023</time>
| 3 minutes</div><div class=tags><a href=/tags/opinions/>opinions</a>
<a href=/tags/terraform/>terraform</a>
<a href=/tags/design/>design</a></div></div></div></div></header></article><div class=article-post><blockquote><p>Modules are containers for multiple resources that are used together.</p></blockquote><p>Terraform modules is a way to bundle a bunch of Terraform resources into one group. Although not explicitly mentioned in the definition, it is also a way to provide an <strong>abstraction</strong> to the resources inside the module and only expose inputs and outputs that are relevant to the users of the module.</p><h2 id=terraform-module-as-an-abstraction-layer><a href=#terraform-module-as-an-abstraction-layer class=anchor><svg class="icon" aria-hidden="true" focusable="false" height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg>
</a>Terraform Module as an Abstraction Layer</h2><p>A Terraform resource usually tends to be generic in that it allows you to configure it multiple ways through the input variables that it can accept. For example, the <code>aws_mskconnect_connector</code> resource has <a href=https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/mskconnect_connector#worker_log_delivery-configuration-block>3 options</a> for log delivery: CloudWatch Logs, Kinesis Data Firehose, or S3. In most cases, your module <strong>shouldn&rsquo;t</strong> expose all 3 options to your users. Your organization probably already has some standard place where you send you logs to e.g. S3 for example where it gets forwarded to another logs search service for later use.</p><p>Therefore, your module should only expose the S3 option and leave out CloudWatch Logs and Kinesis Data Firehose from your module. By doing this you eliminate the choice from the user and they don&rsquo;t have to think which one to use. Your Terraform code can be a lot simpler too.</p><h2 id=module-abstraction-in-action><a href=#module-abstraction-in-action class=anchor><svg class="icon" aria-hidden="true" focusable="false" height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg>
</a>Module Abstraction in Action</h2><p>Here&rsquo;s an example module code when including all 3 options:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-terraform data-lang=terraform><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;log_delivery_s3&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>type</span> = <span class=nx>object</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=na>bucket_arn</span> = <span class=nx>string</span>
</span></span><span class=line><span class=cl>    <span class=na>prefix</span>     = <span class=nx>optional</span><span class=p>(</span><span class=nx>string</span><span class=p>,</span> <span class=s2>&#34;mskconnect-logs&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>default</span> = <span class=nx>null</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;log_delivery_cloudwatch_logs&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>type</span> = <span class=nx>object</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=na>log_group</span> = <span class=nx>string</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>default</span> = <span class=nx>null</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;log_delivery_firehose&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>type</span> = <span class=nx>object</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=na>delivery_stream</span> = <span class=nx>string</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>default</span> = <span class=nx>null</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_mskconnect_connector&#34;</span> <span class=s2>&#34;example&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>name</span> = <span class=s2>&#34;example&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>log_delivery</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>worker_log_delivery</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>dynamic</span> <span class=s2>&#34;s3&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>for_each</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>log_delivery_s3</span> <span class=o>!=</span> <span class=nx>null</span> <span class=o>?</span> <span class=p>[</span><span class=m>1</span><span class=p>]</span> <span class=o>:</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=na>enabled</span>    = <span class=kc>true</span>
</span></span><span class=line><span class=cl>        <span class=na>bucket_arn</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>log_delivery_s3</span><span class=p>.</span><span class=nx>bucket_arn</span>
</span></span><span class=line><span class=cl>        <span class=na>prefix</span>     = <span class=nb>var</span><span class=p>.</span><span class=nx>log_delivery_s3</span><span class=p>.</span><span class=nx>prefix</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>dynamic</span> <span class=s2>&#34;cloudwatch_logs&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>for_each</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>log_delivery_cloudwatch_logs</span> <span class=o>!=</span> <span class=nx>null</span> <span class=o>?</span> <span class=p>[</span><span class=m>1</span><span class=p>]</span> <span class=o>:</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=na>enabled</span>   = <span class=kc>true</span>
</span></span><span class=line><span class=cl>        <span class=na>log_group</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>log_delivery_cloudwatch_logs</span><span class=p>.</span><span class=nx>log_group</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>dynamic</span> <span class=s2>&#34;firehose&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>for_each</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>log_delivery_firehose</span> <span class=o>!=</span> <span class=nx>null</span> <span class=o>?</span> <span class=p>[</span><span class=m>1</span><span class=p>]</span> <span class=o>:</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=na>enabled</span>         = <span class=kc>true</span>
</span></span><span class=line><span class=cl>        <span class=na>delivery_stream</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>log_delivery_firehose</span><span class=p>.</span><span class=nx>delivery_stream</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>And here&rsquo;s an example when we only offer S3 option:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-terraform data-lang=terraform><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;log_delivery_s3&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>type</span> = <span class=nx>object</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=na>bucket_arn</span> = <span class=nx>string</span>
</span></span><span class=line><span class=cl>    <span class=na>prefix</span>     = <span class=nx>optional</span><span class=p>(</span><span class=nx>string</span><span class=p>,</span> <span class=s2>&#34;mskconnect-logs&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>default</span> = <span class=nx>null</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_mskconnect_connector&#34;</span> <span class=s2>&#34;example&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>name</span> = <span class=s2>&#34;example&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>log_delivery</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>worker_log_delivery</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>s3</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>enabled</span>    = <span class=nb>var</span><span class=p>.</span><span class=nx>log_delivery_s3</span> <span class=o>!=</span> <span class=nx>null</span>
</span></span><span class=line><span class=cl>        <span class=na>bucket_arn</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>log_delivery_s3</span><span class=p>.</span><span class=nx>bucket_arn</span>
</span></span><span class=line><span class=cl>        <span class=na>prefix</span>     = <span class=nb>var</span><span class=p>.</span><span class=nx>log_delivery_s3</span><span class=p>.</span><span class=nx>prefix</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>See how simple and shorter the code become? No need to use those <code>dynamic</code> blocks just to conditionally add or remove the log delivery option block anymore.</p><h2 id=but-i-might-need-to-use-that-other-option-in-the-future><a href=#but-i-might-need-to-use-that-other-option-in-the-future class=anchor><svg class="icon" aria-hidden="true" focusable="false" height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg>
</a>But I might need to use that other option in the future&mldr;</h2><p><a href=https://martinfowler.com/bliki/Yagni.html>YAGNI.</a></p></div></div><div class=container><nav class="flex container suggested"><a rel=prev href=/articles/k8s-cluster-access-tailscale/ title="Previous post (older)"><span>Previous</span>
Access internal kubernetes services from anywhere using Tailscale
</a><a rel=next href=/articles/steampipe-duckdb-flow-logs/ title="Next post (newer)"><span>Next</span>
Using Steampipe + DuckDB for VPC Flow Logs Analysis</a></nav></div><div class=container></div></main></main><footer class="footer flex"><section class=container><nav class=footer-links><a href=/index.xml>RSS</a></nav></section><script defer src=/ts/features.706a523ba43e6d0427c7fdf2b9d05dbd0920d3f12942b453690b495cb2522743.js data-enable-footnotes=true></script></footer></body></html>