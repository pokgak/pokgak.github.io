<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=theme-color content="dark"><title>Instrumenting a Slack bot with OpenTelemetry | Aiman Ismail</title><meta property="og:site_name" content="Aiman Ismail"><meta property="og:title" content="Instrumenting a Slack bot with OpenTelemetry | Aiman Ismail"><meta itemprop=name content="Instrumenting a Slack bot with OpenTelemetry | Aiman Ismail"><meta name=twitter:title content="Instrumenting a Slack bot with OpenTelemetry | Aiman Ismail"><meta name=application-name content="Instrumenting a Slack bot with OpenTelemetry | Aiman Ismail"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://pokgak.xyz/images/slack-span-lifetime.png"><meta name=description content="I'm learning stuff."><meta name=twitter:description content="I'm learning stuff."><meta itemprop=description content="I'm learning stuff."><meta property="og:description" content="I'm learning stuff."><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=stylesheet href=/sass/main.min.ab99ff095f832511e24ffb2fba2b51ad473b2f7e9301d674eba2c6c3a6e8bd81.css></head><script>(function(){const e="ThemeColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="ThemeColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.userColorScheme="dark":document.documentElement.dataset.userColorScheme="light"})()</script><body class=dark><nav class=navbar><div class=container><div class=flex><div><a class=brand href=/>Aiman Ismail</a></div><div class=flex><a href=/articles/>Articles</a>
<button id=dark-mode-button><svg class="light" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform:rotate(360deg);-webkit-transform:rotate(360deg);transform:rotate(360deg)" viewBox="0 0 36 36"><path fill="#ffd983" d="M30.312.776C32 19 20 32 .776 30.312c8.199 7.717 21.091 7.588 29.107-.429C37.9 21.867 38.03 8.975 30.312.776z"/><path d="M30.705 15.915a1.163 1.163.0 101.643 1.641 1.163 1.163.0 00-1.643-1.641zm-16.022 14.38a1.74 1.74.0 000 2.465 1.742 1.742.0 100-2.465zm13.968-2.147a2.904 2.904.0 01-4.108.0 2.902 2.902.0 010-4.107 2.902 2.902.0 014.108.0 2.902 2.902.0 010 4.107z" fill="#ffcc4d"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)"/></svg><svg class="dark" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform:rotate(360deg);-webkit-transform:rotate(360deg);transform:rotate(360deg)" viewBox="0 0 36 36"><path fill="#ffd983" d="M16 2s0-2 2-2 2 2 2 2v2s0 2-2 2-2-2-2-2V2zm18 14s2 0 2 2-2 2-2 2h-2s-2 0-2-2 2-2 2-2h2zM4 16s2 0 2 2-2 2-2 2H2s-2 0-2-2 2-2 2-2h2zm5.121-8.707s1.414 1.414.0 2.828-2.828.0-2.828.0L4.878 8.708s-1.414-1.414.0-2.829c1.415-1.414 2.829.0 2.829.0l1.414 1.414zm21 21s1.414 1.414.0 2.828-2.828.0-2.828.0l-1.414-1.414s-1.414-1.414.0-2.828 2.828.0 2.828.0l1.414 1.414zm-.413-18.172s-1.414 1.414-2.828.0.0-2.828.0-2.828l1.414-1.414s1.414-1.414 2.828.0.0 2.828.0 2.828l-1.414 1.414zm-21 21s-1.414 1.414-2.828.0.0-2.828.0-2.828l1.414-1.414s1.414-1.414 2.828.0.0 2.828.0 2.828l-1.414 1.414zM16 32s0-2 2-2 2 2 2 2v2s0 2-2 2-2-2-2-2v-2z"/><circle fill="#ffd983" cx="18" cy="18" r="10"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)"/></svg></button></div></div></div></nav><main><div class=container><article><header class=article-header><div class=thumb><div><h1>Instrumenting a Slack bot with OpenTelemetry</h1><div class=post-meta><div>By Aiman Ismail | <time>August 13, 2022</time>
| 5 minutes</div><div class=tags><a href=/tags/observability/>observability</a>
<a href=/tags/otel-slack/>otel-slack</a></div></div></div></div></header></article><div class=article-post><p><em>Note: I&rsquo;m using pseudocode in the code example in this article to keep the article brief. Please refer to the official Slack and OpenTelemetry documentation for the actual code.</em></p><p>I&rsquo;ve talked about the basics of OpenTelemetry in my previous article. In this one, I&rsquo;ll explain more on how we&rsquo;re integrating OpenTelemetry with our Slack-based application.</p><p><img loading=lazy src=/images/slack-span-lifetime.png alt="Summary of spans and events created" width=2030 height=751></p><h2 id=slack-boltjs-socket-mode><a href=#slack-boltjs-socket-mode class=anchor><svg class="icon" aria-hidden="true" focusable="false" height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a>Slack BoltJS Socket Mode</h2><p>Compared to the a standard HTTP request/response, we&rsquo;re using BoltJS with socket mode. This gives us the advantage of not having the application exposed publicly to be able to accept requests from Slack but this also means that we cannot just use the auto-instrumentation for HTTP developed by the community.</p><p>Socket mode uses WebSocket to establish connection to Slack and exchange messages through that connection. There is no official auto-instrumentation support for the <code>ws</code> library that is used by BoltJS socket mode but I found <a href=https://www.npmjs.com/package/opentelemetry-instrumentation-ws>opentelemetry-instrumentation-ws</a>, a 3rd-party library for <code>ws</code> library auto-instrumentation.</p><p>Spent a few days integrating it into our application and in the end I concluded that the auto-instrumentation provided by the opentelemetry-instrumentation-ws is too low-level. Our goal is to track user interactions with the application - when they use the bot, which option they choose, what were they trying to do, and whether the interaction ends successfully or with an error. The library, however, created spans when a new connection is established between our application and Slack but no spans or events for user interactions.</p><p>So, the conclusion? We&rsquo;ll instrument the application manually.</p><h2 id=creating-and-ending-spans><a href=#creating-and-ending-spans class=anchor><svg class="icon" aria-hidden="true" focusable="false" height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a>Creating and Ending Spans</h2><p>Since this application is used company-wide, it&rsquo;s highly likely that multiple users will be using it in parallel. To track user interactions independent from each other, we&rsquo;ll also need separate spans for each user.</p><p>I decided to go with an object <code>spanStore</code> storing the user spans. Like a singleton pattern, a new span will be created for that user if it doesn&rsquo;t exist yet in <code>spanStore</code>, otherwise it will just return the existing user span.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>spanStore</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>getUserSpan</span><span class=p>(</span><span class=nx>username</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>user</span> <span class=k>in</span> <span class=nx>spanStore</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>spanStore</span><span class=p>[</span><span class=nx>username</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>span</span> <span class=o>=</span> <span class=nx>startSpan</span><span class=p>(</span><span class=nx>username</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>spanStore</span><span class=p>[</span><span class=nx>username</span><span class=p>]</span> <span class=o>=</span> <span class=nx>span</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>span</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Now that we have a function to create the span, when in the lifetime of the incoming event do we create the span? Ideally, as early as possible before anything else so that we can track everything. BoltJS supports setting a <a href=https://slack.dev/bolt-js/concepts#global-middleware>global middleware</a> that will be called before the event handler function are called. This is where I call the <code>getUserSpan()</code> function above. For the first event for that user, it will create a new span and for the next events it will just return the existing spans that I can use.</p><p>Next, when do you end the span? Due to how the application works, we&rsquo;re assuming that each user can only have one session at one time and at the end there will always be an finishing event triggered when the user finished their interaction with the application. Based on that fact, I wrote an event listener that will respond to this finishing event by calling the OTel function to end the span and remove the span from the <code>spanStore</code> object above.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>event</span><span class=p>({</span><span class=nx>id</span><span class=o>:</span> <span class=s1>&#39;finishing_event&#39;</span><span class=p>},</span> <span class=kr>async</span> <span class=p>({</span><span class=nx>username</span><span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>span</span> <span class=o>=</span> <span class=nx>getUserSpan</span><span class=p>(</span><span class=nx>username</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>span</span><span class=p>.</span><span class=nx>end</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>removeSpanFromSpanStore</span><span class=p>(</span><span class=nx>span</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=tracking-user-actions-with-span-events><a href=#tracking-user-actions-with-span-events class=anchor><svg class="icon" aria-hidden="true" focusable="false" height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a>Tracking User Actions with Span Events</h2><p>With these, we have a separate span for each user for the whole duration of their interaction with the application. With only one span, we don&rsquo;t have insights yet into what the user are doing, which actions are taken by the user, so we&rsquo;ll need a way to track user actions.</p><p>With Slack BoltJS, we can trigger a listener function on every user interaction. I wrote a function that will create a new span event using the user input id as the event name. I also passed in the whole payload so that the we can see the payload of user actions later when debugging issues. Add this as another global middleware, now we&rsquo;re creating a new event for every user actions.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>action</span><span class=p>(</span><span class=s1>&#39;callback_id&#39;</span><span class=p>,</span> <span class=kr>async</span> <span class=p>({</span><span class=nx>username</span><span class=p>,</span> <span class=nx>action_id</span><span class=p>,</span> <span class=nx>payload</span><span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>span</span> <span class=o>=</span> <span class=nx>getUserSpan</span><span class=p>(</span><span class=nx>username</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>span</span><span class=p>.</span><span class=nx>addEvent</span><span class=p>(</span><span class=nx>action_id</span><span class=p>,</span> <span class=p>{</span><span class=nx>payload</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=confession><a href=#confession class=anchor><svg class="icon" aria-hidden="true" focusable="false" height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a>Confession</h2><p>I&rsquo;m actually not convinced that my way of doing this is correct. One of the reason is that since I use one root span for the whole interaction for a user, I&rsquo;m also tracking the duration taken by the user to do the next action. From our perpective, this made the duration of the span tracked is now kinda useless for us since it also includes factors that are not controllable by us (time taken for users to do the next action).</p><p>Instead of one root span and creating new span events for every user interaction, maybe a new span for each interaction, linked to the previous span would be better since we only track the duration that we are in control of, not how long the user takes to click a button.</p><p>Nevertheless, since I already implemented like this now, let&rsquo;s see how that will turn out. Like the saying, you either die a hero, or you live long enough to see yourself become the villain.</p></div></div><div class=container><nav class="flex container suggested"><a rel=prev href=/articles/otel-basics/ title="Previous post (older)"><span>Previous</span>
OpenTelemetry Basics</a></nav></div><div class=container></div></main></main><footer class="footer flex"><section class=container><nav class=footer-links><a href=/index.xml>RSS</a></nav></section><script defer src=/ts/features.dd8e5b18a6dda91367e396fd8dc9b9f83a1993065f709a53e056e0f2e9096ea1.js data-enable-footnotes=true></script></footer></body></html>