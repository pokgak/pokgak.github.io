<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=theme-color content="dark"><title>Atlantis: run policy check using policies from S3 | Aiman Ismail</title><meta property="og:site_name" content="Aiman Ismail"><meta property="og:title" content="Atlantis: run policy check using policies from S3 | Aiman Ismail"><meta itemprop=name content="Atlantis: run policy check using policies from S3 | Aiman Ismail"><meta name=twitter:title content="Atlantis: run policy check using policies from S3 | Aiman Ismail"><meta name=application-name content="Atlantis: run policy check using policies from S3 | Aiman Ismail"><meta name=twitter:card content="summary"><meta name=description content="I'm learning stuff."><meta name=twitter:description content="I'm learning stuff."><meta itemprop=description content="I'm learning stuff."><meta property="og:description" content="I'm learning stuff."><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=stylesheet href=/sass/main.min.ab99ff095f832511e24ffb2fba2b51ad473b2f7e9301d674eba2c6c3a6e8bd81.css></head><script>(function(){const e="ThemeColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="ThemeColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.userColorScheme="dark":document.documentElement.dataset.userColorScheme="light"})()</script><body class=dark><nav class=navbar><div class=container><div class=flex><div><a class=brand href=/>Aiman Ismail</a></div><div class=flex><a href=/articles/>Articles</a>
<button id=dark-mode-button><svg class="light" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform:rotate(360deg);-webkit-transform:rotate(360deg);transform:rotate(360deg)" viewBox="0 0 36 36"><path fill="#ffd983" d="M30.312.776C32 19 20 32 .776 30.312c8.199 7.717 21.091 7.588 29.107-.429C37.9 21.867 38.03 8.975 30.312.776z"/><path d="M30.705 15.915a1.163 1.163.0 101.643 1.641 1.163 1.163.0 00-1.643-1.641zm-16.022 14.38a1.74 1.74.0 000 2.465 1.742 1.742.0 100-2.465zm13.968-2.147a2.904 2.904.0 01-4.108.0 2.902 2.902.0 010-4.107 2.902 2.902.0 014.108.0 2.902 2.902.0 010 4.107z" fill="#ffcc4d"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)"/></svg><svg class="dark" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform:rotate(360deg);-webkit-transform:rotate(360deg);transform:rotate(360deg)" viewBox="0 0 36 36"><path fill="#ffd983" d="M16 2s0-2 2-2 2 2 2 2v2s0 2-2 2-2-2-2-2V2zm18 14s2 0 2 2-2 2-2 2h-2s-2 0-2-2 2-2 2-2h2zM4 16s2 0 2 2-2 2-2 2H2s-2 0-2-2 2-2 2-2h2zm5.121-8.707s1.414 1.414.0 2.828-2.828.0-2.828.0L4.878 8.708s-1.414-1.414.0-2.829c1.415-1.414 2.829.0 2.829.0l1.414 1.414zm21 21s1.414 1.414.0 2.828-2.828.0-2.828.0l-1.414-1.414s-1.414-1.414.0-2.828 2.828.0 2.828.0l1.414 1.414zm-.413-18.172s-1.414 1.414-2.828.0.0-2.828.0-2.828l1.414-1.414s1.414-1.414 2.828.0.0 2.828.0 2.828l-1.414 1.414zm-21 21s-1.414 1.414-2.828.0.0-2.828.0-2.828l1.414-1.414s1.414-1.414 2.828.0.0 2.828.0 2.828l-1.414 1.414zM16 32s0-2 2-2 2 2 2 2v2s0 2-2 2-2-2-2-2v-2z"/><circle fill="#ffd983" cx="18" cy="18" r="10"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)"/></svg></button></div></div></div></nav><main><div class=container><article><header class=article-header><div class=thumb><div><h1>Atlantis: run policy check using policies from S3</h1><div class=post-meta><div>By Aiman Ismail | <time>November 16, 2022</time>
| 4 minutes</div><div class=tags><a href=/tags/atlantis/>atlantis</a>
<a href=/tags/opa/>opa</a>
<a href=/tags/conftest/>conftest</a>
<a href=/tags/policy/>policy</a>
<a href=/tags/s3/>s3</a>
<a href=/tags/terraform/>terraform</a></div></div></div></div></header></article><div class=article-post><p><a href=https://www.runatlantis.io>Atlantis</a> is an application used for collaborating on a Terraform code base using pull requests and one of the feature that it has is to run <a href=conftest.dev>conftest</a> and test a set of defined OPA policies. At the moment I&rsquo;m writing this article, Atlantis only supports using local sources i.e. local filesystem as the source of the policy. In this article, I&rsquo;ll show an example of how to use an S3 bucket instead as the source for the policies.</p><h2 id=custom-workflow-and-run-step><a href=#custom-workflow-and-run-step class=anchor><svg class="icon" aria-hidden="true" focusable="false" height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a>Custom workflow and <code>run</code> step</h2><p>Atlantis supports using <a href=https://www.runatlantis.io/docs/custom-workflows.html>custom workflows</a> to override the default commands that it runs and as part of that feature, it supports defining any <a href=https://www.runatlantis.io/docs/custom-workflows.html#running-custom-commands>custom commands</a> to run as part of the steps for each stage. We will be ~abusing~using this feature to override the default <code>conftest</code> command that Atlantis uses and specify our policy through the <code>--update</code> flag of <code>conftest</code></p><h2 id=conftest---update-flag><a href=#conftest---update-flag class=anchor><svg class="icon" aria-hidden="true" focusable="false" height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a>conftest <code>--update</code> flag</h2><p>By using <code>--update</code> you can tell <code>conftest</code> to pull the policy first every time it wants to run the tests. We will be using an S3 bucket as our source but before we can pull from S3, you have to make sure that wherever the Atlantis server is running, it can access and have permission to pull objects from the bucket. In my case, Atlantis is running as a StatefulSet inside a Kubernetes cluster so I have already configured the IAM permission needed for it to access the bucket.</p><p><code>conftest</code> is using the <a href=https://github.com/hashicorp/go-getter>go-getter package</a> underneath to pull these packages so technically it should be possible to also pull from other sources that <code>go-getter</code> supports, other than just S3.</p><h2 id=result><a href=#result class=anchor><svg class="icon" aria-hidden="true" focusable="false" height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a>Result</h2><p>Combining both of the features described above, here&rsquo;s an example of a simplified <a href=https://www.runatlantis.io/docs/server-side-repo-config.html>repo config</a> that I use:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># minimal config for brevity; you might need to configure more options to make atlantis works properly</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>repos</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>github.com/$ORG/$REPO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>workflow</span><span class=p>:</span><span class=w> </span><span class=l>custom</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>workflows</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>custom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>policy_check</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>show</span><span class=w> </span><span class=c># important don&#39;t skip this step</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>conftest test $SHOWFILE --update s3::https://s3-us-east-1.amazonaws.com/$BUCKET_NAME/policy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>policies</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>policy_sets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>policy-from-s3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/home/atlantis/policy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>source</span><span class=p>:</span><span class=w> </span><span class=l>local</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>In the example above, under the <code>workflows</code> key, I&rsquo;m defining a custom workflow named <code>custom</code> and inside that custom workflow, I&rsquo;m overriding the default <code>policy_check</code> steps with my own. My custom <code>policy_check</code> steps consists of the <code>show</code> step and the custom <code>run</code> step. The <code>show</code> step is crucial since this is when Atlantis will run <code>terraform show</code> to convert your Terraform planfile to a JSON formatted file. When using the custom <code>run</code> step, Atlantis will store the path to this JSON formatted file in variable <code>$SHOWFILE</code> so when I ran my conftest command you can see that I&rsquo;m using <code>$SHOWFILE</code> to run <code>conftest</code> against the file. Optional: if you want to run <code>conftest</code> against the Terraform files too, you can add <code>*.tf</code> after <code>$SHOWFILE</code> and it will include all the <code>*tf</code> files in that project directory.</p><p>Next comes the <code>--update</code> flag, to specify the S3 bucket, I&rsquo;m using a URL format that is <a href=https://github.com/hashicorp/go-getter#s3-bucket-examples>specified by the <code>go-getter</code> package</a> replacing <code>$BUCKET_NAME</code> with the bucket name that I have configured with the correct permission and network access. Inside the S3 bucket, this is how I structured the files. I put all the OPA policies inside a folder <code>policy</code> since <code>conftest</code> complains when I just put all the policies directly at the root level inside the bucket. YMMV.</p><pre tabindex=0><code>$BUCKET_NAME/
├─ policy/
│  ├─ stop_it.rego
│  ├─ dont_kill_server.rego
</code></pre><p>After defining our custom workflow, we can specify the custom worklow as the default workflow for a repo. This is done by setting the <code>repos[].workflow</code> value to the name of our custom workflow, in my case it&rsquo;s <code>custom</code>.</p><p>Next, as part of the using the policy check feature in Atlantis, you are required to set the <code>policies</code> values. You can refer to the <a href=https://www.runatlantis.io/docs/server-side-repo-config.html#policies>docs</a> for the full configuration required. Inside the <code>policies</code> key, there is a required <code>policy_check</code> key that is used to specify where Atlantis can find the OPA policies to use when running <code>conftest</code>. Usually, this is a folder on a local filesystem already containing the policies but in our case, since we&rsquo;re using the <code>--update</code> flag, we just need to specify any folder on the local filesystem that will be writable by the Atlantis user. You can see in the example above that I&rsquo;m using <code>/home/atlantis/policy</code>.</p><h2 id=conclusion><a href=#conclusion class=anchor><svg class="icon" aria-hidden="true" focusable="false" height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a>Conclusion</h2><p>That&rsquo;s all you need to do configure to make Atlantis pulls policies from S3 (and include Terraform source code files in your <code>contest</code> run). Shoutout to a <a href=https://doordash.engineering/2022/09/20/how-doordash-ensures-velocity-and-reliability-through-policy-automation/>DoorDash engineering blog post</a> which mentioned briefly that they pulled their policies from S3 and made me curios how to do the same using Atlantis. You can mention me on Twitter (@pokgak73) if this article has helped you. That would most definitely made my day :)</p></div></div><div class=container><nav class="flex container suggested"><a rel=prev href=/articles/opa-conftest/ title="Previous post (older)"><span>Previous</span>
Getting started with OPA and conftest</a></nav></div><div class=container></div></main></main><footer class="footer flex"><section class=container><nav class=footer-links><a href=/index.xml>RSS</a></nav></section><script defer src=/ts/features.dd8e5b18a6dda91367e396fd8dc9b9f83a1993065f709a53e056e0f2e9096ea1.js data-enable-footnotes=true></script></footer></body></html>