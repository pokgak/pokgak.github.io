<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=theme-color content="dark"><title>Access your kubernetes service from anywhere using Tailscale | Aiman Ismail</title><meta property="og:site_name" content="Aiman Ismail"><meta property="og:title" content="Access your kubernetes service from anywhere using Tailscale | Aiman Ismail"><meta itemprop=name content="Access your kubernetes service from anywhere using Tailscale | Aiman Ismail"><meta name=twitter:title content="Access your kubernetes service from anywhere using Tailscale | Aiman Ismail"><meta name=application-name content="Access your kubernetes service from anywhere using Tailscale | Aiman Ismail"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://pokgak.xyz/images/k8s-external-dns-tailscale.png"><meta name=description content="I'm learning stuff."><meta name=twitter:description content="I'm learning stuff."><meta itemprop=description content="I'm learning stuff."><meta property="og:description" content="I'm learning stuff."><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=stylesheet href=/sass/main.min.ab99ff095f832511e24ffb2fba2b51ad473b2f7e9301d674eba2c6c3a6e8bd81.css></head><script>(function(){const e="ThemeColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="ThemeColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.userColorScheme="dark":document.documentElement.dataset.userColorScheme="light"})()</script><body class=dark><nav class=navbar><div class=container><div class=flex><div><a class=brand href=/>Aiman Ismail</a></div><div class=flex><a href=/articles/>Articles</a>
<button id=dark-mode-button><svg class="light" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform:rotate(360deg);-webkit-transform:rotate(360deg);transform:rotate(360deg)" viewBox="0 0 36 36"><path fill="#ffd983" d="M30.312.776C32 19 20 32 .776 30.312c8.199 7.717 21.091 7.588 29.107-.429C37.9 21.867 38.03 8.975 30.312.776z"/><path d="M30.705 15.915a1.163 1.163.0 101.643 1.641 1.163 1.163.0 00-1.643-1.641zm-16.022 14.38a1.74 1.74.0 000 2.465 1.742 1.742.0 100-2.465zm13.968-2.147a2.904 2.904.0 01-4.108.0 2.902 2.902.0 010-4.107 2.902 2.902.0 014.108.0 2.902 2.902.0 010 4.107z" fill="#ffcc4d"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)"/></svg><svg class="dark" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform:rotate(360deg);-webkit-transform:rotate(360deg);transform:rotate(360deg)" viewBox="0 0 36 36"><path fill="#ffd983" d="M16 2s0-2 2-2 2 2 2 2v2s0 2-2 2-2-2-2-2V2zm18 14s2 0 2 2-2 2-2 2h-2s-2 0-2-2 2-2 2-2h2zM4 16s2 0 2 2-2 2-2 2H2s-2 0-2-2 2-2 2-2h2zm5.121-8.707s1.414 1.414.0 2.828-2.828.0-2.828.0L4.878 8.708s-1.414-1.414.0-2.829c1.415-1.414 2.829.0 2.829.0l1.414 1.414zm21 21s1.414 1.414.0 2.828-2.828.0-2.828.0l-1.414-1.414s-1.414-1.414.0-2.828 2.828.0 2.828.0l1.414 1.414zm-.413-18.172s-1.414 1.414-2.828.0.0-2.828.0-2.828l1.414-1.414s1.414-1.414 2.828.0.0 2.828.0 2.828l-1.414 1.414zm-21 21s-1.414 1.414-2.828.0.0-2.828.0-2.828l1.414-1.414s1.414-1.414 2.828.0.0 2.828.0 2.828l-1.414 1.414zM16 32s0-2 2-2 2 2 2 2v2s0 2-2 2-2-2-2-2v-2z"/><circle fill="#ffd983" cx="18" cy="18" r="10"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)"/></svg></button></div></div></div></nav><main><div class=container><article><header class=article-header><div class=thumb><div><h1>Access your kubernetes service from anywhere using Tailscale</h1><div class=post-meta><div>By Aiman Ismail | <time>September 12, 2023</time>
| 6 minutes</div><div class=tags><a href=/tags/kubernetes/>kubernetes</a>
<a href=/tags/tailscale/>tailscale</a>
<a href=/tags/external-dns/>external-dns</a>
<a href=/tags/networking/>networking</a></div></div></div></div></header></article><div class=article-post><p><img loading=lazy src=/images/k8s-external-dns-tailscale.png alt="Full flow" width=5207 height=1886></p><p>I recently setup a local kubernetes in my home network to play with and one of the issues that I faced is that it is hard to access the services inside the cluster from my laptop. I don&rsquo;t have a load-balancer in my setup so everytime I want to access a service from my laptop, I&rsquo;ll have to run <code>kubectl port-forward</code> first before using the localhost address to access it. It works but it&rsquo;s annoying.</p><p>Usually in cloud environments like AWS, you would setup an <a href=https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/>ingress-controller</a> that will provision a load balancer for you and use that load balancer to expose your services inside the cluster to the internet using Ingress resources. Your incoming traffic from the internet will then be routed through the load balancer into your cluster onto your pods. Unfortunately, you don&rsquo;t get the same thing when hosting your cluster locally outside of the cloud environment. You have to manually configure your network to allow access from the internet.</p><h3 id=so-what-options-do-we-have><a href=#so-what-options-do-we-have class=anchor><svg class="icon" aria-hidden="true" focusable="false" height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a>So what options do we have?</h3><p>One way we can do it is to use a Service with type NodePort to use the host port and access the pods using the host IP, this will allow access to services inside the cluster to your local network but still not from the internet. To allow access from the internet, you&rsquo;ll have to open a port on your router to route to the host IP from the NodePort service.</p><p>I&rsquo;m not a fan of opening my home network to the internet. Home routers is infamous for being vulnerable and easily exploitable. I don&rsquo;t want mine to be part of a new legion of botnets that will <a href=https://blog.cloudflare.com/cloudflare-mitigates-record-breaking-71-million-request-per-second-ddos-attack/>break a new record for biggest DDoS attack</a>. Using the NodePort service type also is not that great. With NodePort service, you&rsquo;ll have to specify the node IP to access along with the port assigned and your traffic will always go to that node and the pods running on it. More reason on why NodePort is a bad idea on <a href=https://devops.stackexchange.com/a/17084>StackOverflow</a>.</p><p>What other option do we have? <a href=https://tailscale.com>Tailscale</a>!</p><h3 id=tailscale-subnet-router><a href=#tailscale-subnet-router class=anchor><svg class="icon" aria-hidden="true" focusable="false" height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a>Tailscale Subnet Router</h3><p>Tailscale is a mesh VPN built on top of <a href=https://www.wireguard.com/>Wireguard</a>. I&rsquo;ve been using it for a long time for accessing my personal servers at home while I&rsquo;m outside and I love it. It is so simple to setup you don&rsquo;t have to know any networking magic to use it. No need to mess around with creating your own CA (*cough*OpenVPN*cough*). Tailscale will create a peer-to-peer network from your client to your other Tailscale devices and it is also really smart in figuring out a way to punch a hole through your home network ([see Resources section][###Resources]) to connect to the internet so you don&rsquo;t have to open a port on your home router anymore. Bot legion problem solved!</p><p>One of the way you can use Tailscale is by configuring a Tailscale node as a <strong>subnet router</strong>. Usually, when you have 10 devices in your network, you&rsquo;ll have to install Tailscale on each of those devices to connect it to your VPN network but with a subnet router only one Tailscale node in that network is enough, as long as that subnet router node have network access to all the devices in that network. You&rsquo;ll have to configure your subnet router to advertise the route of the internal cluster network that the subnet router is in using CIDR range e.g. <code>10.43.0.0/16</code> so that other devices outside of that network will know to look for the subnet router if they want to access the IP address from that CIDR range.</p><h4 id=eli5-subnet-router-advertisement><a href=#eli5-subnet-router-advertisement class=anchor><svg class="icon" aria-hidden="true" focusable="false" height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a>ELI5: subnet router advertisement</h4><p>You&rsquo;re a postman trying to deliver a parcel. Your parcel destination is set to unit A-1-2-3 in the TRX Exchange 106 building. You&rsquo;ve never been to TRX before so you don&rsquo;t know which floor the office actually is but you noticed there&rsquo;s a big signboard at the reception saying &ldquo;Come here if you have parcel for unit A-1-0-0 to A-9-9-9&rdquo;. So, you went the reception and then the nice lady at the reception gave you the direction to reach the office unit A-1-2-3 for you to deliver your parcel.</p><p>The reception here is like our subnet router. All the traffic meant for the network have to go through the subnet router first, then they&rsquo;re passed through to the actual packet destination.</p><h3 id=i-dont-want-to-remember-all-this-ip-addresses><a href=#i-dont-want-to-remember-all-this-ip-addresses class=anchor><svg class="icon" aria-hidden="true" focusable="false" height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a>I don&rsquo;t want to remember all this IP addresses</h3><p>With a subnet router, you can now reach any of the services inside the cluster using the ClusterIP of that service but IP address is not human-friendly and you don&rsquo;t want to (you can&rsquo;t!) memorize all the IP addresses for all the services inside the cluster. So, now we need something that will map our IP addresses to a human-friendly format. Sounds familiar? We can use DNS records.</p><p>You can definitely create DNS records manually and map it to each of the ClusterIP for your services. That&rsquo;s what I did for testing when validating this setup actually. At scale, that won&rsquo;t work tho. You don&rsquo;t want to be the one to manually go to your DNS registrar and create the records one by one. Luckily, in kubernetes there is an application called external-dns.</p><h3 id=external-dns-to-the-rescue><a href=#external-dns-to-the-rescue class=anchor><svg class="icon" aria-hidden="true" focusable="false" height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a>External-dns to the rescue</h3><p>External-dns is an application that runs inside your kubernetes cluster and it periodically queries the kubernetes API for the list of all Service and Ingress resources. From the list, it checks whether it should create a DNS record for the resources based on the resource annotation. It supports a lot of DNS providers like AWS Route53, Cloudflare, Google Cloud DNS and more. For my setup I&rsquo;m using Cloudflare.</p><p>By default, external-dns will only create DNS records for Ingress resource or Service with type LoadBalancer. For my setup, since I&rsquo;m self-hosting the kubernetes inside my home network and don&rsquo;t have access to a load balancer, I have to <a href=https://github.com/pokgak/gitops/blob/0a880ec3e08481a7c50e67995fd4092dfb3c92f4/system/external-dns.yaml#L18>add an extra configuration parameter</a> to external-dns so that it will create DNS records for ClusterIP Service type. On the Service resource itself, usually external-dns searches for the <a href=https://github.com/kubernetes-sigs/external-dns/blob/master/docs/annotations/annotations.md#external-dnsalphakubernetesiohostname><code>external-dns.alpha.kubernetes.io/hostname</code> annotation</a> but since we&rsquo;re using it with ClusterIP, I have to change it to <a href=https://github.com/kubernetes-sigs/external-dns/blob/master/docs/annotations/annotations.md#external-dnsalphakubernetesiointernal-hostname><code>external-dns.alpha.kubernetes.io/internal-hostname</code></a>.</p><h3 id=tailscale--external-dns--><a href=#tailscale--external-dns-- class=anchor><svg class="icon" aria-hidden="true" focusable="false" height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a>Tailscale + external-dns = ❤️</h3><pre tabindex=0><code>➜ dig prometheus.k8s.pokgak.xyz +short
10.43.170.163
</code></pre><p>With those changes applied. All new Service resources in my kubernetes cluster that have the annotation will get one DNS record. Now, if I try to resolve a name for a service inside the cluster, it will return me a internal ClusterIP. Combined with the Tailscale subnet-router we&rsquo;ve configured earlier, now you can access services inside your cluster from any of your Tailscale devices from any part of the world.</p><p>With tailscale, you&rsquo;ll also have an additional layer of authentication. Only users in your Tailscale networks can access the exposed services. For others, they might be able to guess what you have running in your cluster from your DNS records but they won&rsquo;t be able to access it since all the IPs will be private IPs. For the next part, I&rsquo;m looking into exposing some service inside my cluster to the internet <strong>fully</strong> without having to be in the Tailscale network. Tailscale Funnel suppose to do just that but I still haven&rsquo;t tested if it&rsquo;s working with services inside kubernetes.</p><h3 id=resources><a href=#resources class=anchor><svg class="icon" aria-hidden="true" focusable="false" height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a>Resources</h3><ul><li><a href=https://tailscale.com/blog/how-tailscale-works/>How Tailscale Works</a>: explanation on how Tailscale uses Wireguard to create a mesh VPN network architecture.</li><li><a href=https://tailscale.com/blog/how-nat-traversal-works/>How NAT traversal works</a>: recommended read even if you&rsquo;re not a networking geek. You&rsquo;ll learn a thing or two about networking for sure.</li><li><a href=https://github.com/pokgak/gitops/blob/0a880ec3e08481a7c50e67995fd4092dfb3c92f4/system/external-dns.yaml>Full cofiguration for external-dns helm chart</a></li><li><a href=https://github.com/pokgak/gitops/blob/0a880ec3e08481a7c50e67995fd4092dfb3c92f4/system/kube-prometheus-stack.yaml#L20>external-dns annotation for the services</a></li></ul></div></div><div class=container><nav class="flex container suggested"><a rel=prev href=/articles/on-public-speaking/ title="Previous post (older)"><span>Previous</span>
On Public Speaking</a></nav></div><div class=container></div></main></main><footer class="footer flex"><section class=container><nav class=footer-links><a href=/index.xml>RSS</a></nav></section><script defer src=/ts/features.706a523ba43e6d0427c7fdf2b9d05dbd0920d3f12942b453690b495cb2522743.js data-enable-footnotes=true></script></footer></body></html>